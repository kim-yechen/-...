<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOW - AI Workflow Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f8fafc; margin:0; }
        .canvas-dot { background-image: radial-gradient(#cbd5e1 1.2px, transparent 1.2px); background-size: 30px 30px; }
        .node { transition: box-shadow 0.2s ease; z-index: 10; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        #canvas-container { position: relative; width: 100vw; height: calc(100vh - 80px); overflow: hidden; cursor: crosshair; }
        svg.conn-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .custom-shadow { shadow-2xl: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
    </style>
</head>
<body>

    <!-- Dashboard View -->
    <div id="dashboard" class="h-screen w-full flex flex-col items-center justify-center p-6 bg-slate-50">
        <div class="max-w-md w-full text-center">
            <h1 class="text-8xl font-black text-slate-900 mb-2 italic tracking-tighter">FLOW</h1>
            <p class="text-indigo-600 font-bold tracking-[0.4em] text-[10px] mb-12 uppercase">Intelligent Workflow Engine</p>
            <button onclick="showCreateModal()" class="w-full bg-slate-900 text-white py-8 rounded-[2.5rem] font-black text-2xl shadow-2xl hover:bg-indigo-600 transition-all flex items-center justify-center gap-4 active:scale-95">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                프로젝트 시작하기
            </button>
            <div id="project-list" class="mt-12 text-left space-y-3"></div>
        </div>
    </div>

    <!-- Canvas View -->
    <div id="app-canvas" class="hidden h-screen w-full bg-white flex flex-col overflow-hidden select-none">
        <header class="h-20 border-b flex items-center justify-between px-10 bg-white z-20 shrink-0">
            <div class="flex items-center gap-6">
                <button onclick="goToDashboard()" class="p-3 hover:bg-slate-50 rounded-2xl text-slate-400 transition-colors">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </button>
                <h2 id="project-title-display" class="font-black text-slate-900 text-xl tracking-tight">Project Name</h2>
            </div>
            <div class="flex gap-4">
                <button onclick="addNode('memo')" class="flex items-center gap-2 bg-slate-100 text-slate-700 px-6 py-3 rounded-2xl font-bold hover:bg-slate-200 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    메모 블록
                </button>
                <button onclick="addNode('ai')" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><rect x="9" y="9" width="6" height="6"></rect><line x1="9" y1="1" x2="9" y2="4"></line><line x1="15" y1="1" x2="15" y2="4"></line><line x1="9" y1="20" x2="9" y2="23"></line><line x1="15" y1="20" x2="15" y2="23"></line><line x1="20" y1="9" x2="23" y2="9"></line><line x1="20" y1="15" x2="23" y2="15"></line><line x1="1" y1="9" x2="4" y2="9"></line><line x1="1" y1="15" x2="4" y2="15"></line></svg>
                    AI 지시 블록
                </button>
            </div>
        </header>
        
        <div id="canvas-container" class="bg-slate-50">
            <div class="absolute inset-0 opacity-[0.05] pointer-events-none canvas-dot"></div>
            <svg id="connections-svg" class="conn-svg">
                <defs>
                    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#cbd5e1" />
                    </marker>
                </defs>
            </svg>
            <div id="nodes-layer"></div>
        </div>
    </div>

    <!-- Modals & Panels -->
    <div id="create-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl max-w-md w-full border border-slate-200">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 block">New Workflow Name</label>
            <input id="new-project-name" type="text" placeholder="이름을 입력하세요..." class="w-full border-b-4 border-slate-100 py-3 text-2xl font-black outline-none focus:border-indigo-600 mb-8 transition-all" />
            <div class="flex gap-4">
                <button onclick="hideCreateModal()" class="flex-1 font-bold text-slate-400">취소</button>
                <button onclick="confirmCreateProject()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black active:scale-95 transition-all">생성</button>
            </div>
        </div>
    </div>

    <div id="side-panel" class="hidden fixed top-0 right-0 h-full w-[450px] bg-white border-l shadow-2xl z-50 flex flex-col animate-in slide-in-from-right transition-transform duration-300">
        <div class="p-10 border-b flex justify-between items-center">
            <h3 class="font-black text-slate-900 text-2xl uppercase tracking-tighter">Properties</h3>
            <button onclick="closePanel()" class="p-3 hover:bg-slate-100 rounded-full transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="flex-1 p-10 overflow-y-auto space-y-12">
            <div class="space-y-4">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block ml-2">Content Payload</label>
                <textarea id="panel-content" oninput="updateNodeContentFromPanel(this.value)" class="w-full h-96 p-8 bg-slate-50 border-4 border-transparent focus:border-indigo-600 focus:bg-white rounded-[2.5rem] outline-none transition-all text-base font-bold text-slate-800 shadow-inner"></textarea>
            </div>
        </div>
        <div class="p-10 bg-slate-50 border-t flex gap-4">
            <button id="delete-node-btn" class="flex-1 py-5 text-red-500 font-black hover:bg-red-50 rounded-2xl transition-colors">삭제</button>
            <button onclick="closePanel()" class="flex-[2] py-5 bg-indigo-600 text-white font-black rounded-2xl shadow-xl">완료</button>
        </div>
    </div>

    <script>
        let state = {
            currentProject: null,
            projects: [],
            isDragging: false,
            draggedId: null,
            dragOffset: { x: 0, y: 0 },
            selectedNodeId: null,
            connectSourceId: null
        };

        function showCreateModal() { document.getElementById('create-modal').classList.remove('hidden'); document.getElementById('new-project-name').focus(); }
        function hideCreateModal() { document.getElementById('create-modal').classList.add('hidden'); }

        function confirmCreateProject() {
            const name = document.getElementById('new-project-name').value.trim() || "새 워크플로우";
            const newProject = {
                id: 'p_' + Date.now(),
                title: name,
                nodes: [
                    { id: 'n1', type: 'memo', x: 100, y: 150, content: '기초 데이터 블록' },
                    { id: 'n2', type: 'ai', x: 500, y: 150, content: 'AI 분석 지침' }
                ],
                connections: [{ from: 'n1', to: 'n2' }]
            };
            state.projects.push(newProject);
            openProject(newProject.id);
            hideCreateModal();
            document.getElementById('new-project-name').value = '';
        }

        function openProject(id) {
            state.currentProject = state.projects.find(p => p.id === id);
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('app-canvas').classList.remove('hidden');
            document.getElementById('project-title-display').innerText = state.currentProject.title;
            renderCanvas();
        }

        function goToDashboard() {
            state.currentProject = null;
            document.getElementById('app-canvas').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            renderProjectList();
        }

        function renderProjectList() {
            const container = document.getElementById('project-list');
            if (state.projects.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = `<p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-4 mb-4">Saved Engines</p>` + 
                state.projects.map(p => `
                    <div onclick="openProject('${p.id}')" class="bg-white p-6 rounded-3xl cursor-pointer border-2 border-transparent hover:border-indigo-600 shadow-sm flex justify-between items-center group transition-all">
                        <span class="font-bold text-slate-800 text-lg group-hover:text-indigo-600">${p.title}</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" class="text-slate-300 group-hover:text-indigo-600 group-hover:translate-x-1 transition-all"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </div>
                `).join('');
        }

        function addNode(type) {
            const newNode = {
                id: 'n_' + Date.now(),
                type: type,
                x: 200 + (Math.random() * 50),
                y: 200 + (Math.random() * 50),
                content: type === 'ai' ? '명령어를 적어주세요.' : '메모를 적어주세요.'
            };
            state.currentProject.nodes.push(newNode);
            renderCanvas();
        }

        function renderCanvas() {
            const nodesLayer = document.getElementById('nodes-layer');
            nodesLayer.innerHTML = state.currentProject.nodes.map(node => `
                <div id="${node.id}" 
                     onmousedown="handleMouseDown(event, '${node.id}')"
                     style="left: ${node.x}px; top: ${node.y}px;" 
                     class="node absolute w-72 bg-white rounded-[2.5rem] shadow-2xl border-4 ${state.selectedNodeId === node.id ? 'border-indigo-600' : (state.connectSourceId === node.id ? 'border-amber-400' : 'border-white')}">
                    <div class="p-8">
                        <div class="flex justify-between items-center mb-6">
                            <span class="text-[9px] font-black uppercase px-3 py-1.5 rounded-full tracking-wider ${node.type === 'ai' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}">${node.type}</span>
                            <div class="flex gap-2">
                                <button onclick="startConnection(event, '${node.id}')" class="p-2 rounded-xl ${state.connectSourceId === node.id ? 'bg-amber-100 text-amber-600' : 'bg-slate-50 text-slate-300 hover:text-indigo-600'}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                </button>
                                <button onclick="openPanel('${node.id}')" class="p-2 bg-slate-50 text-slate-300 hover:text-indigo-600 rounded-xl">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-slate-800 font-bold h-14 line-clamp-3 leading-relaxed">${node.content}</p>
                    </div>
                </div>
            `).join('');
            drawConnections();
        }

        function drawConnections() {
            const svg = document.getElementById('connections-svg');
            const lines = state.currentProject.connections.map(conn => {
                const from = state.currentProject.nodes.find(n => n.id === conn.from);
                const to = state.currentProject.nodes.find(n => n.id === conn.to);
                if (!from || !to) return '';
                const x1 = from.x + 280; const y1 = from.y + 45; const x2 = to.x; const y2 = to.y + 45;
                const dx = Math.abs(x2 - x1) * 0.4;
                return `<path d="M ${x1} ${y1} C ${x1 + dx} ${y1}, ${x2 - dx} ${y2}, ${x2} ${y2}" fill="none" stroke="#cbd5e1" stroke-width="4" marker-end="url(#arrow)" stroke-linecap="round" />`;
            }).join('');
            svg.innerHTML = `<defs><marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#cbd5e1" /></marker></defs>` + lines;
        }

        function handleMouseDown(e, id) {
            if (e.target.closest('button')) return;
            state.isDragging = true; state.draggedId = id;
            const node = state.currentProject.nodes.find(n => n.id === id);
            state.dragOffset = { x: e.clientX - node.x, y: e.clientY - node.y };
            document.getElementById(id).style.zIndex = 100;
        }

        document.addEventListener('mousemove', (e) => {
            if (!state.isDragging || !state.draggedId) return;
            const node = state.currentProject.nodes.find(n => n.id === state.draggedId);
            node.x = e.clientX - state.dragOffset.x; node.y = e.clientY - state.dragOffset.y;
            const el = document.getElementById(state.draggedId);
            el.style.left = node.x + 'px'; el.style.top = node.y + 'px';
            drawConnections();
        });

        document.addEventListener('mouseup', () => {
            if (state.draggedId) document.getElementById(state.draggedId).style.zIndex = 10;
            state.isDragging = false; state.draggedId = null;
        });

        function openPanel(id) {
            state.selectedNodeId = id;
            const node = state.currentProject.nodes.find(n => n.id === id);
            document.getElementById('panel-content').value = node.content;
            document.getElementById('side-panel').classList.remove('hidden');
            document.getElementById('delete-node-btn').onclick = () => {
                state.currentProject.nodes = state.currentProject.nodes.filter(n => n.id !== id);
                state.currentProject.connections = state.currentProject.connections.filter(c => c.from !== id && c.to !== id);
                closePanel();
            };
            renderCanvas();
        }

        function closePanel() { state.selectedNodeId = null; document.getElementById('side-panel').classList.add('hidden'); renderCanvas(); }
        function updateNodeContentFromPanel(val) {
            const node = state.currentProject.nodes.find(n => n.id === state.selectedNodeId);
            if (node) { node.content = val; const nodeEl = document.getElementById(node.id); if (nodeEl) nodeEl.querySelector('p').innerText = val; }
        }

        function startConnection(e, id) {
            e.stopPropagation();
            if (!state.connectSourceId) {
                state.connectSourceId = id;
            } else {
                if (state.connectSourceId !== id) {
                    const exists = state.currentProject.connections.find(c => c.from === state.connectSourceId && c.to === id);
                    if (!exists) state.currentProject.connections.push({ from: state.connectSourceId, to: id });
                }
                state.connectSourceId = null;
            }
            renderCanvas();
        }

        window.onload = () => { renderProjectList(); };
    </script>
</body>
</html>
