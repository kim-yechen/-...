import React, { useState, useEffect, useCallback } from 'react';
import { 
  Plus, Play, Trash2, ChevronLeft, LayoutGrid, 
  Link2, MousePointer2, MessageSquare, Cpu, X, Zap, 
  ArrowRight, Save 
} from 'lucide-react';

const App = () => {
  // --- 상태 관리 ---
  const [view, setView] = useState('dashboard');
  const [projects, setProjects] = useState([]);
  const [currentProjectId, setCurrentProjectId] = useState(null);
  
  // 프로젝트 생성용 모달 상태
  const [isCreating, setIsCreating] = useState(false);
  const [newProjectName, setNewProjectName] = useState('');

  // 캔버스 UI 상태
  const [isDragging, setIsDragging] = useState(false);
  const [draggedId, setDraggedId] = useState(null);
  const [offset, setOffset] = useState({ x: 0, y: 0 });
  const [selectedNodeId, setSelectedNodeId] = useState(null);
  const [connectSourceId, setConnectSourceId] = useState(null);

  const currentProject = projects.find(p => p.id === currentProjectId);

  // --- 핵심 액션 ---
  const handleCreateConfirm = () => {
    if (!newProjectName.trim()) return;
    
    const newId = "p_" + Date.now();
    const newProj = {
      id: newId,
      title: newProjectName,
      nodes: [
        { id: 'n1', type: 'memo', x: 50, y: 100, content: '기초 데이터 블록입니다.' },
        { id: 'n2', type: 'ai', x: 400, y: 100, content: '위 데이터를 분석하여 보고서 초안을 작성해줘.' }
      ],
      connections: [{ from: 'n1', to: 'n2' }]
    };
    
    setProjects(prev => [...prev, newProj]);
    setCurrentProjectId(newId);
    setNewProjectName('');
    setIsCreating(false);
    setView('canvas');
  };

  const addNode = (type) => {
    const newNode = {
      id: 'n_' + Date.now(),
      type: type,
      x: 100 + (Math.random() * 50),
      y: 100 + (Math.random() * 50),
      content: type === 'ai' ? 'AI 실행 지시사항을 입력하세요.' : '새로운 메모 데이터입니다.'
    };
    setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, nodes: [...p.nodes, newNode] } : p));
  };

  const handleConnect = (targetId) => {
    if (!connectSourceId || connectSourceId === targetId) {
      setConnectSourceId(null);
      return;
    }
    const exists = currentProject.connections.find(c => c.from === connectSourceId && c.to === targetId);
    let newConns = exists 
      ? currentProject.connections.filter(c => !(c.from === connectSourceId && c.to === targetId))
      : [...currentProject.connections, { from: connectSourceId, to: targetId }];
      
    setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, connections: newConns } : p));
    setConnectSourceId(null);
  };

  // --- 드래그 핸들러 ---
  const onMouseDown = (e, id) => {
    if (e.target.closest('.no-drag')) return;
    setIsDragging(true);
    setDraggedId(id);
    const node = currentProject.nodes.find(n => n.id === id);
    setOffset({ x: e.clientX - node.x, y: e.clientY - node.y });
  };

  const onMouseMove = (e) => {
    if (!isDragging || !draggedId) return;
    const newNodes = currentProject.nodes.map(n => 
      n.id === draggedId ? { ...n, x: e.clientX - offset.x, y: e.clientY - offset.y } : n
    );
    setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, nodes: newNodes } : p));
  };

  const onMouseUp = () => {
    setIsDragging(false);
    setDraggedId(null);
  };

  const getCurvePath = (x1, y1, x2, y2) => {
    const dx = Math.abs(x2 - x1) * 0.4;
    return `M ${x1 + 280} ${y1 + 40} C ${x1 + 280 + dx} ${y1 + 40}, ${x2 - dx} ${y2 + 40}, ${x2} ${y2 + 40}`;
  };

  // --- 대시보드 화면 ---
  if (view === 'dashboard') {
    return (
      <div className="h-screen w-full bg-white flex flex-col items-center justify-center p-6 font-sans">
        <div className="max-w-md w-full text-center">
          <div className="mb-12">
            <h1 className="text-7xl font-black text-slate-900 mb-4 tracking-tighter">FLOW</h1>
            <p className="text-slate-400 font-bold uppercase tracking-[0.4em] text-[10px]">AI Work-Relation Engine</p>
          </div>

          {!isCreating ? (
            <button 
              onClick={() => setIsCreating(true)}
              className="w-full bg-slate-900 text-white py-8 rounded-[2.5rem] font-black text-2xl shadow-2xl hover:bg-indigo-600 transition-all active:scale-95 flex items-center justify-center gap-4 group"
            >
              <Plus size={32} className="group-hover:rotate-90 transition-transform" /> 
              프로젝트 시작하기
            </button>
          ) : (
            <div className="bg-slate-50 p-8 rounded-[2.5rem] border-2 border-slate-100 animate-in zoom-in-95 duration-200">
              <input 
                autoFocus
                type="text"
                placeholder="워크플로우 이름..."
                className="w-full bg-transparent border-b-4 border-slate-200 py-3 text-2xl font-black outline-none focus:border-indigo-500 mb-6 transition-colors"
                value={newProjectName}
                onChange={(e) => setNewProjectName(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleCreateConfirm()}
              />
              <div className="flex gap-3">
                <button onClick={() => setIsCreating(false)} className="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600">취소</button>
                <button onClick={handleCreateConfirm} className="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-100">생성하기</button>
              </div>
            </div>
          )}

          {projects.length > 0 && (
            <div className="mt-16 text-left">
              <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-6 ml-2">Recent Workflows</p>
              <div className="grid grid-cols-1 gap-3 max-h-[250px] overflow-y-auto pr-2">
                {projects.map(p => (
                  <div key={p.id} onClick={() => { setCurrentProjectId(p.id); setView('canvas'); }}
                       className="bg-white border-2 border-slate-50 p-6 rounded-3xl cursor-pointer hover:border-indigo-600 hover:shadow-xl transition-all flex justify-between items-center group">
                    <h3 className="font-bold text-slate-800 text-lg group-hover:text-indigo-600">{p.title}</h3>
                    <ArrowRight className="text-slate-200 group-hover:text-indigo-600 group-hover:translate-x-1 transition-all" />
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  // --- 캔버스 화면 ---
  const selectedNode = currentProject?.nodes.find(n => n.id === selectedNodeId);

  return (
    <div className="h-screen w-full bg-white flex flex-col overflow-hidden select-none" onMouseMove={onMouseMove} onMouseUp={onMouseUp}>
      <header className="h-20 border-b flex items-center justify-between px-8 bg-white z-20 shrink-0">
        <div className="flex items-center gap-6">
          <button onClick={() => setView('dashboard')} className="p-3 hover:bg-slate-50 rounded-2xl text-slate-400 transition-colors">
            <LayoutGrid size={24} />
          </button>
          <h2 className="font-black text-slate-900 text-xl tracking-tight">{currentProject.title}</h2>
        </div>
        <div className="flex gap-3">
          <button onClick={() => addNode('memo')} className="flex items-center gap-2 bg-slate-100 text-slate-700 px-5 py-2.5 rounded-xl font-bold hover:bg-slate-200 transition-all no-drag">
            <MessageSquare size={18} /> 메모 블록
          </button>
          <button onClick={() => addNode('ai')} className="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all no-drag">
            <Cpu size={18} /> AI 지시 블록
          </button>
        </div>
      </header>

      <div className="flex-1 relative bg-slate-50 overflow-hidden">
        <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{ backgroundImage: 'radial-gradient(#000 1.5px, transparent 1.5px)', backgroundSize: '30px 30px' }}></div>
        
        {/* 연결선 SVG 레이어 */}
        <svg className="absolute inset-0 w-full h-full pointer-events-none">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#cbd5e1" />
            </marker>
          </defs>
          {currentProject.connections.map((conn, i) => {
            const from = currentProject.nodes.find(n => n.id === conn.from);
            const to = currentProject.nodes.find(n => n.id === conn.to);
            if (!from || !to) return null;
            return (
              <path key={i} d={getCurvePath(from.x, from.y, to.x, to.y)} 
                    fill="none" stroke="#cbd5e1" strokeWidth="3" markerEnd="url(#arrow)" />
            );
          })}
        </svg>

        {/* 블록 렌더링 */}
        {currentProject.nodes.map(node => (
          <div key={node.id} onMouseDown={(e) => onMouseDown(e, node.id)}
               style={{ left: node.x, top: node.y }}
               className={`absolute w-72 bg-white rounded-[2rem] shadow-2xl border-2 transition-all cursor-grab active:cursor-grabbing
               ${connectSourceId === node.id ? 'border-amber-400 ring-4 ring-amber-50' : selectedNodeId === node.id ? 'border-indigo-500' : 'border-transparent'}`}>
            
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <span className={`text-[9px] font-black uppercase px-2 py-1 rounded-lg tracking-wider ${node.type === 'ai' ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-50 text-slate-500'}`}>
                  {node.type === 'ai' ? 'AI INSTRUCTION' : 'DATA MEMO'}
                </span>
                <div className="flex gap-1 no-drag">
                  <button onClick={(e) => { e.stopPropagation(); setConnectSourceId(node.id); }} className={`p-2 rounded-lg transition-colors ${connectSourceId === node.id ? 'bg-amber-100 text-amber-600' : 'hover:bg-slate-50 text-slate-300'}`}>
                    <Link2 size={16} />
                  </button>
                  {connectSourceId && connectSourceId !== node.id && (
                    <button onClick={(e) => { e.stopPropagation(); handleConnect(node.id); }} className="p-2 bg-amber-500 text-white rounded-lg animate-pulse">
                      <MousePointer2 size={16} />
                    </button>
                  )}
                  <button onClick={(e) => { e.stopPropagation(); setSelectedNodeId(node.id); }} className="p-2 hover:bg-slate-50 text-slate-300 rounded-lg">
                    <Zap size={16} />
                  </button>
                </div>
              </div>
              <p className="text-sm text-slate-700 font-bold leading-relaxed line-clamp-3 overflow-hidden h-14">
                {node.content || <span className="text-slate-200">내용을 입력하세요...</span>}
              </p>
            </div>
          </div>
        ))}
      </div>

      {/* 우측 에디터 패널 */}
      {selectedNode && (
        <div className="w-[400px] bg-white border-l shadow-2xl z-30 flex flex-col animate-in slide-in-from-right duration-300">
          <div className="p-8 border-b flex justify-between items-center">
            <h3 className="font-black text-slate-900 uppercase tracking-tighter text-xl">Block Details</h3>
            <button onClick={() => setSelectedNodeId(null)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><X /></button>
          </div>
          <div className="flex-1 p-8 overflow-y-auto space-y-10">
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Block Content</label>
                <span className={`px-3 py-1 rounded-full text-[10px] font-black ${selectedNode.type === 'ai' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'}`}>
                  {selectedNode.type.toUpperCase()}
                </span>
              </div>
              <textarea 
                className="w-full h-80 p-6 bg-slate-50 border-4 border-transparent focus:border-indigo-600 focus:bg-white rounded-[2rem] outline-none transition-all text-base leading-relaxed font-bold text-slate-700"
                value={selectedNode.content}
                onChange={(e) => {
                  const val = e.target.value;
                  const newNodes = currentProject.nodes.map(n => n.id === selectedNode.id ? { ...n, content: val } : n);
                  setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, nodes: newNodes } : p));
                }}
              />
            </div>
            {selectedNode.type === 'ai' && (
              <button className="w-full py-5 bg-indigo-600 text-white rounded-3xl font-black text-lg shadow-xl shadow-indigo-100 flex items-center justify-center gap-3 hover:bg-indigo-700 active:scale-95 transition-all group">
                <Play size={20} fill="currentColor" className="group-hover:scale-110 transition-transform" /> AI 실행 프로세스 가동
              </button>
            )}
          </div>
          <div className="p-8 bg-slate-50 border-t flex gap-4">
            <button 
              onClick={() => {
                const newNodes = currentProject.nodes.filter(n => n.id !== selectedNode.id);
                setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, nodes: newNodes } : p));
                setSelectedNodeId(null);
              }}
              className="flex-1 py-4 text-red-400 font-black hover:bg-red-50 rounded-2xl transition-all flex items-center justify-center gap-2 border-2 border-transparent hover:border-red-100"
            >
              <Trash2 size={18} /> 삭제
            </button>
            <button onClick={() => setSelectedNodeId(null)} className="flex-1 py-4 bg-slate-900 text-white font-black rounded-2xl shadow-lg">저장 완료</button>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
