<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOW_ENGINE</title>
    <!-- 브라우저에서 리액트를 즉시 실행하게 해주는 도구들 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #f8fafc; margin: 0; overflow: hidden; }
        .node-shadow { box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15); }
        .grid-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        .no-select { user-select: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 아이콘을 직접 내장 (외부 라이브러리 차단 대비)
        const Icon = ({ name, size = 20 }) => {
            const icons = {
                zap: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
                plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                play: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
                link: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                x: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
                grid: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            const [connectionSource, setConnectionSource] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [newProjectTitle, setNewProjectTitle] = useState('');
            const [draggedNode, setDraggedNode] = useState(null);
            const [offset, setOffset] = useState({ x: 0, y: 0 });

            const currentProject = projects.find(p => p.id === currentProjectId);

            // API 호출 함수 (Exponential Backoff 적용)
            const callAi = async (prompt) => {
                const apiKey = ""; // 실제 API 키 필요
                if (!apiKey) return "API 키가 설정되지 않았습니다.";
                
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            return data.candidates?.[0]?.content?.parts?.[0]?.text;
                        }
                    } catch (e) {
                        await new Promise(r => setTimeout(r, delay));
                        delay *= 2;
                    }
                }
                return "연결 실패";
            };

            const handleCreateProject = () => {
                if (!newProjectTitle.trim()) return;
                const newId = `p_${Date.now()}`;
                setProjects([...projects, {
                    id: newId,
                    title: newProjectTitle,
                    nodes: [{ id: 'n1', content: '여기에 명령을 입력하세요.', x: 100, y: 150, type: 'input', status: 'idle' }],
                    connections: []
                }]);
                setCurrentProjectId(newId);
                setView('canvas');
                setIsModalOpen(false);
                setNewProjectTitle('');
            };

            const addNode = (type) => {
                const newNode = { id: `node_${Date.now()}`, content: '', x: 200, y: 200, type, status: 'idle' };
                setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: [...p.nodes, newNode] } : p));
            };

            const executeNode = async (nodeId) => {
                const node = currentProject.nodes.find(n => n.id === nodeId);
                setIsAiProcessing(true);
                setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: p.nodes.map(n => n.id === nodeId ? { ...n, status: 'loading' } : n) } : p));

                const result = await callAi(node.content);
                const conn = currentProject.connections.find(c => c.from === nodeId);
                
                if (conn) {
                    setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: p.nodes.map(n => n.id === conn.to ? { ...n, content: result, status: 'done' } : n.id === nodeId ? { ...n, status: 'idle' } : n) } : p));
                } else {
                    const outId = `out_${Date.now()}`;
                    setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: [...p.nodes, { id: outId, content: result, x: node.x + 350, y: node.y, type: 'output', status: 'done' }], connections: [...p.connections, { from: nodeId, to: outId }] } : p));
                }
                setIsAiProcessing(false);
            };

            // 드래그 로직
            const onMouseDown = (e, node) => {
                if (e.target.closest('button') || e.target.closest('textarea')) return;
                setDraggedNode(node.id);
                setOffset({ x: e.clientX - node.x, y: e.clientY - node.y });
            };

            const onMouseMove = (e) => {
                if (draggedNode) {
                    const newNodes = currentProject.nodes.map(n => n.id === draggedNode ? { ...n, x: e.clientX - offset.x, y: e.clientY - offset.y } : n);
                    setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: newNodes } : p));
                }
            };

            return (
                <div className="h-screen w-full flex flex-col no-select" onMouseMove={onMouseMove} onMouseUp={() => setDraggedNode(null)}>
                    <header className="h-16 bg-white border-b flex items-center justify-between px-8 z-50 shrink-0">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setView('dashboard')}>
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="zap"/></div>
                            <span className="font-black text-xl italic text-slate-800 tracking-tighter">FLOW_ENGINE</span>
                        </div>
                        {view === 'canvas' && (
                            <div className="flex gap-3">
                                <button onClick={() => addNode('input')} className="px-5 py-2 bg-slate-100 rounded-xl text-sm font-bold hover:bg-slate-200">입력 블록</button>
                                <button onClick={() => addNode('output')} className="px-5 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-md hover:bg-indigo-700">출력 블록</button>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 relative overflow-hidden bg-slate-100 grid-bg">
                        {view === 'dashboard' ? (
                            <div className="p-16 max-w-6xl mx-auto">
                                <div className="flex justify-between items-end mb-12">
                                    <h1 className="text-6xl font-black text-slate-900 leading-tight">Your<br/>Workflows</h1>
                                    <button onClick={() => setIsModalOpen(true)} className="px-10 py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-2xl hover:scale-105 transition-all">프로젝트 생성</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {projects.map(p => (
                                        <div key={p.id} onClick={() => { setCurrentProjectId(p.id); setView('canvas'); }} className="bg-white p-10 rounded-[2.5rem] shadow-sm hover:shadow-2xl border border-slate-100 cursor-pointer group transition-all">
                                            <div className="text-indigo-600 mb-6 group-hover:scale-110 transition-transform"><Icon name="grid" size={32} /></div>
                                            <h3 className="text-2xl font-black text-slate-800">{p.title}</h3>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="w-full h-full relative" onClick={() => setConnectionSource(null)}>
                                <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ zIndex: 5 }}>
                                    {currentProject?.connections.map((c, i) => {
                                        const f = currentProject.nodes.find(n => n.id === c.from);
                                        const t = currentProject.nodes.find(n => n.id === c.to);
                                        if (!f || !t) return null;
                                        return <path key={i} d={`M ${f.x + 300} ${f.y + 80} C ${f.x + 380} ${f.y + 80}, ${t.x - 80} ${t.y + 80}, ${t.x} ${t.y + 80}`} stroke="#6366f1" strokeWidth="3" fill="none" opacity="0.3" />;
                                    })}
                                </svg>
                                {currentProject?.nodes.map(node => (
                                    <div key={node.id} onMouseDown={(e) => onMouseDown(e, node)}
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (connectionSource && connectionSource !== node.id) {
                                                const newConns = [...currentProject.connections, { from: connectionSource, to: node.id }];
                                                setProjects(projects.map(p => p.id === currentProjectId ? { ...p, connections: newConns } : p));
                                                setConnectionSource(null);
                                            }
                                        }}
                                        className={`absolute w-[300px] bg-white rounded-[2rem] p-6 node-shadow border-4 transition-all z-10 
                                        ${connectionSource === node.id ? 'border-amber-400 scale-105 animate-pulse' : 'border-white'} 
                                        ${node.status === 'loading' ? 'ring-4 ring-indigo-100 animate-pulse' : ''}`}
                                        style={{ left: node.x, top: node.y }}>
                                        <div className="flex justify-between items-center mb-4">
                                            <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${node.type === 'input' ? 'bg-indigo-50 text-indigo-600' : 'bg-emerald-50 text-emerald-600'}`}>{node.type}</span>
                                            <div className="flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); setConnectionSource(node.id); }} className={`p-2 rounded-lg ${connectionSource === node.id ? 'bg-amber-400 text-white' : 'text-slate-200 hover:text-indigo-600'}`}><Icon name="link" size={16}/></button>
                                                {node.type === 'input' && <button onClick={() => executeNode(node.id)} className="p-2 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700"><Icon name="play" size={16}/></button>}
                                                <button onClick={() => { setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: p.nodes.filter(n => n.id !== node.id) } : p)) }} className="p-2 text-slate-200 hover:text-red-500"><Icon name="trash" size={16}/></button>
                                            </div>
                                        </div>
                                        <textarea className="w-full bg-slate-50 p-4 rounded-xl border-none outline-none resize-none h-32 text-sm font-bold text-slate-700 leading-relaxed shadow-inner" value={node.content} 
                                            onChange={(e) => {
                                                const newNodes = currentProject.nodes.map(n => n.id === node.id ? { ...n, content: e.target.value } : n);
                                                setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: newNodes } : p));
                                            }} onMouseDown={(e) => e.stopPropagation()} />
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[3rem] p-12 w-full max-w-md shadow-2xl relative">
                                <h2 className="text-3xl font-black text-slate-800 mb-8 italic">New Project</h2>
                                <input className="w-full bg-slate-50 border-none p-5 rounded-2xl mb-8 outline-none focus:ring-4 ring-indigo-100 font-bold text-xl" placeholder="프로젝트 이름..." value={newProjectTitle} onChange={(e) => setNewProjectTitle(e.target.value)} />
                                <div className="flex gap-4">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-4 font-bold text-slate-400">취소</button>
                                    <button onClick={handleCreateProject} className="flex-1 py-4 font-black bg-indigo-600 text-white rounded-2xl shadow-xl hover:bg-indigo-700">시작하기</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
