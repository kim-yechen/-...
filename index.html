<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workflow Canvas (Real Engine)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel CDN for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;900&display=swap');
        body { 
            font-family: 'Pretendard', sans-serif; 
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f8fafc;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(226, 232, 240, 0.8); 
        }
        .node-glow { transition: all 0.3s ease; }
        .node-glow:hover { 
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.2); 
            transform: translateY(-2px); 
        }
        .btn-action:active { transform: scale(0.95); }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, useCallback } = React;
        
        // Lucide Icon Component Wrapper
        const Icon = ({ name, size = 18, className = "", fill = "none" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const iconElement = window.lucide.icons[name].toSvg({ 
                        size, 
                        class: className,
                        fill: fill
                    });
                    if (iconRef.current) iconRef.current.innerHTML = iconElement;
                }
            }, [name, size, className, fill]);
            return <span ref={iconRef} className="inline-flex items-center justify-center" />;
        };

        const App = () => {
            // 프로젝트 상태
            const [projects, setProjects] = useState([
                {
                    id: 'p1',
                    title: 'AI 전략 기획',
                    description: '제미나이 API를 활용한 실제 워크플로우 테스트',
                    x: 100, y: 150,
                    nodes: [
                        { id: 'n1', type: 'Input', x: 50, y: 150, content: '여기에 명령어를 입력하세요.', status: 'idle' },
                        { id: 'n2', type: 'Output', x: 450, y: 150, content: '결과가 여기에 표시됩니다.', status: 'idle' },
                    ],
                    connections: [{ from: 'n1', to: 'n2' }]
                }
            ]);

            // 설정 및 AI 상태
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [showApiSettings, setShowApiSettings] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [view, setView] = useState('dashboard');
            const [currentProjectId, setCurrentProjectId] = useState(null);

            const currentProject = useMemo(() => projects.find(p => p.id === currentProjectId) || null, [projects, currentProjectId]);

            // 곡선 경로 계산 함수
            const getCurvePath = (startX, startY, endX, endY) => {
                const dx = Math.abs(endX - startX);
                const offset = Math.max(dx / 2, 50);
                return `M ${startX} ${startY} C ${startX + offset} ${startY}, ${endX - offset} ${endY}, ${endX} ${endY}`;
            };

            // 실제 Gemini API 실행 엔진
            const runGemini = async (nodeId) => {
                if (!apiKey) {
                    setShowApiSettings(true);
                    return;
                }

                const node = currentProject.nodes.find(n => n.id === nodeId);
                setIsAiLoading(true);
                updateNodeStatus(nodeId, 'processing');

                try {
                    // Gemini API 호출 (제공된 진짜 엔진 로직 적용)
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ 
                                parts: [{ text: node.content }] 
                            }] 
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || "API 호출 중 오류가 발생했습니다.");
                    }

                    const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text || "결과를 가져오지 못했습니다.";

                    // 연결된 다음 노드(Output)에 결과 전달
                    const conn = currentProject.connections.find(c => c.from === nodeId);
                    if (conn) {
                        updateNodeContent(conn.to, resultText);
                        updateNodeStatus(conn.to, 'completed');
                    }
                    updateNodeStatus(nodeId, 'completed');
                } catch (e) {
                    console.error(e);
                    alert(`오류 발생: ${e.message}`);
                    updateNodeStatus(nodeId, 'idle');
                } finally {
                    setIsAiLoading(false);
                }
            };

            const updateNodeContent = (id, content) => {
                setProjects(prev => prev.map(p => p.id === currentProjectId ? 
                    {...p, nodes: p.nodes.map(n => n.id === id ? {...n, content} : n)} : p));
            };

            const updateNodeStatus = (id, status) => {
                setProjects(prev => prev.map(p => p.id === currentProjectId ? 
                    {...p, nodes: p.nodes.map(n => n.id === id ? {...n, status} : n)} : p));
            };

            return (
                <div className="h-screen w-full flex flex-col overflow-hidden">
                    {/* API 설정 모달 */}
                    {showApiSettings && (
                        <div className="fixed inset-0 bg-slate-900/60 z-[100] flex items-center justify-center backdrop-blur-sm p-4">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-md shadow-2xl border border-white animate-in zoom-in-95 duration-200">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold flex items-center gap-2">
                                        <Icon name="Settings" className="text-indigo-600"/> API 설정
                                    </h2>
                                    <button onClick={() => setShowApiSettings(false)} className="p-2 hover:bg-slate-100 rounded-full transition-all">
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>
                                <p className="text-sm text-slate-500 mb-6 font-medium leading-relaxed">
                                    Google AI Studio에서 발급받은 API 키를 입력하세요.<br/>키는 브라우저(LocalStorage)에만 안전하게 저장됩니다.
                                </p>
                                <input 
                                    type="password"
                                    className="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl mb-6 outline-none focus:border-indigo-500 focus:bg-white transition-all font-mono"
                                    placeholder="API 키를 입력하세요 (AIzaSy...)"
                                    value={apiKey}
                                    onChange={(e) => {
                                        setApiKey(e.target.value);
                                        localStorage.setItem('gemini_api_key', e.target.value);
                                    }}
                                />
                                <button onClick={() => setShowApiSettings(false)} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95">
                                    설정 저장
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 헤더 */}
                    <header className="bg-white/80 backdrop-blur-md border-b px-6 py-4 flex justify-between items-center z-20 shadow-sm">
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('dashboard')}>
                            <div className="bg-indigo-600 p-2.5 rounded-xl text-white group-hover:rotate-12 transition-transform shadow-indigo-200 shadow-lg">
                                <Icon name="Zap" size={22} fill="white" />
                            </div>
                            <h1 className="text-xl font-black tracking-tight text-slate-800 uppercase">AI Workflow</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className={`hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full border ${apiKey ? 'bg-emerald-50 border-emerald-100 text-emerald-600' : 'bg-amber-50 border-amber-100 text-amber-600'}`}>
                                <div className={`w-2 h-2 rounded-full ${apiKey ? 'bg-emerald-500' : 'bg-amber-500 animate-pulse'}`}></div>
                                <span className="text-[10px] font-bold uppercase tracking-wider">{apiKey ? 'API Connected' : 'API Key Required'}</span>
                            </div>
                            <button onClick={() => setShowApiSettings(true)} className="p-3 hover:bg-slate-100 rounded-2xl transition-all text-slate-400 hover:text-indigo-600 border border-transparent hover:border-slate-200">
                                <Icon name="Settings" size={20} />
                            </button>
                        </div>
                    </header>

                    {view === 'dashboard' ? (
                        <div className="flex-1 p-8 md:p-12 bg-slate-50 overflow-auto">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex justify-between items-end mb-10">
                                    <div>
                                        <h2 className="text-3xl font-black text-slate-900 mb-2">Projects</h2>
                                        <p className="text-slate-500 font-medium">관리 중인 모든 AI 워크플로우</p>
                                    </div>
                                    <button className="bg-white border-2 border-slate-200 px-5 py-3 rounded-2xl font-bold flex items-center gap-2 text-slate-700 hover:border-indigo-600 hover:text-indigo-600 transition-all shadow-sm">
                                        <Icon name="Plus" /> 새 프로젝트
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {projects.map(p => (
                                        <div key={p.id} onClick={() => { setCurrentProjectId(p.id); setView('canvas'); }} 
                                             className="bg-white p-8 rounded-[2.5rem] shadow-sm border-2 border-transparent hover:border-indigo-500 transition-all cursor-pointer group flex flex-col h-72 hover:shadow-xl">
                                            <div className="bg-slate-50 w-14 h-14 rounded-2xl flex items-center justify-center text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors mb-6">
                                                <Icon name="Folder" size={28} />
                                            </div>
                                            <h3 className="font-bold text-xl text-slate-800 mb-2">{p.title}</h3>
                                            <p className="text-slate-400 text-sm leading-relaxed line-clamp-2 flex-1">{p.description}</p>
                                            <div className="flex justify-between items-center mt-4 pt-4 border-t border-slate-50">
                                                <span className="text-[10px] font-black uppercase tracking-widest text-slate-300">{p.nodes.length} Blocks</span>
                                                <div className="flex items-center gap-2 text-indigo-600 font-bold text-sm opacity-0 group-hover:opacity-100 transition-all">
                                                    Open <Icon name="ArrowRight" size={16} className="group-hover:translate-x-1 transition-transform" />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 flex overflow-hidden">
                            <aside className="w-72 bg-white border-r p-6 flex flex-col gap-6 z-10 shadow-sm">
                                <button onClick={() => setView('dashboard')} className="flex items-center gap-3 text-slate-400 hover:text-indigo-600 font-bold transition-colors group">
                                    <Icon name="ChevronLeft" className="group-hover:-translate-x-1 transition-transform"/> 허브로 돌아가기
                                </button>
                                <div className="p-6 bg-indigo-50 rounded-[2rem] border border-indigo-100 flex flex-col gap-3">
                                    <p className="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em]">Engine Status</p>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-3.5 h-3.5 rounded-full ${isAiLoading ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500'} shadow-sm`}></div>
                                        <span className="text-sm font-bold text-slate-700">{isAiLoading ? 'AI 분석 중...' : '작동 가능'}</span>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Components</p>
                                    <div className="space-y-2">
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center gap-3 cursor-pointer hover:bg-white hover:border-indigo-200 transition-all">
                                            <Icon name="Type" className="text-indigo-600" />
                                            <span className="text-sm font-bold text-slate-600">Input Block</span>
                                        </div>
                                        <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center gap-3 cursor-pointer hover:bg-white hover:border-indigo-200 transition-all">
                                            <Icon name="Cpu" className="text-indigo-600" />
                                            <span className="text-sm font-bold text-slate-600">AI Engine</span>
                                        </div>
                                    </div>
                                </div>
                                <button className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-xl active:scale-95 transition-all hover:bg-black">
                                    <Icon name="Plus" size={20} /> 새 블록 추가
                                </button>
                            </aside>

                            <main className="flex-1 relative bg-slate-100/50 overflow-hidden">
                                <div className="absolute inset-0 opacity-[0.03] pointer-events-none" style={{backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '30px 30px'}}></div>
                                
                                <svg className="absolute inset-0 w-full h-full pointer-events-none">
                                    <defs>
                                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
                                            <path d="M0,0 L10,5 L0,10 Z" fill="#cbd5e1" />
                                        </marker>
                                    </defs>
                                    {currentProject.connections.map((c, i) => {
                                        const f = currentProject.nodes.find(n => n.id === c.from);
                                        const t = currentProject.nodes.find(n => n.id === c.to);
                                        if(!f || !t) return null;
                                        return <path key={i} d={getCurvePath(f.x + 224, f.y + 60, t.x, t.y + 60)} fill="none" stroke="#cbd5e1" strokeWidth="2" strokeDasharray="6,6" markerEnd="url(#arrow)" />;
                                    })}
                                </svg>

                                {currentProject.nodes.map(node => (
                                    <div key={node.id} className="absolute w-56 glass-card rounded-[2rem] p-6 shadow-sm border-2 border-transparent hover:border-indigo-400 transition-all cursor-grab active:cursor-grabbing node-glow" style={{left: node.x, top: node.y}}>
                                        <div className="flex justify-between items-center mb-4">
                                            <span className={`text-[9px] font-black px-2 py-1 rounded-lg uppercase tracking-widest ${node.status === 'processing' ? 'bg-amber-100 text-amber-600 animate-pulse' : node.status === 'completed' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>
                                                {node.status}
                                            </span>
                                            {node.type === 'Input' && (
                                                <button onClick={() => runGemini(node.id)} disabled={isAiLoading} className="p-2.5 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-100 disabled:opacity-50 transition-all active:scale-90">
                                                    <Icon name={isAiLoading ? "Loader2" : "Play"} size={14} className={isAiLoading ? "animate-spin" : ""} fill={isAiLoading ? "none" : "white"} />
                                                </button>
                                            )}
                                        </div>
                                        <h4 className="font-black text-[10px] text-indigo-600 uppercase mb-2 tracking-widest flex items-center gap-1">
                                            <Icon name={node.type === 'Input' ? "MessageSquare" : "Zap"} size={10} /> {node.type}
                                        </h4>
                                        <textarea 
                                            className="w-full bg-transparent text-[11px] font-medium text-slate-700 leading-relaxed outline-none resize-none h-28 border-none p-0 placeholder:text-slate-300"
                                            placeholder={node.type === 'Input' ? "질문을 입력하세요..." : "결과가 여기에 표시됩니다."}
                                            value={node.content}
                                            onChange={(e) => updateNodeContent(node.id, e.target.value)}
                                        />
                                    </div>
                                ))}
                            </main>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
