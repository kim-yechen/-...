<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLOW_ENGINE - Stability Version</title>
    <!-- 라이브러리 로딩 (가장 안정적인 버전들) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background: #f8fafc; margin: 0; overflow: hidden; }
        .node-shadow { box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.15); }
        .grid-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 30px 30px; }
        .no-select { user-select: none; }
        textarea::placeholder { color: #cbd5e1; font-weight: 400; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // 아이콘 컴포넌트 (SVG 직접 삽입으로 오류 방지)
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                zap: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
                play: <svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
                link: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
                trash: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
                settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
                loader: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>,
                grid: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            };
            return icons[name] || null;
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [projects, setProjects] = useState([]);
            const [currentProjectId, setCurrentProjectId] = useState(null);
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            const [connectionSource, setConnectionSource] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [newProjectTitle, setNewProjectTitle] = useState('');
            const [draggedNode, setDraggedNode] = useState(null);
            const [offset, setOffset] = useState({ x: 0, y: 0 });

            const currentProject = projects.find(p => p.id === currentProjectId);

            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', apiKey);
                setIsSettingsOpen(false);
            };

            const callAi = async (prompt) => {
                if (!apiKey) {
                    setIsSettingsOpen(true);
                    return "ERROR: API 키를 입력해주세요.";
                }
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    
                    if (!res.ok) {
                        const errorData = await res.json();
                        return `API 오류: ${errorData.error?.message || '연결 실패'}`;
                    }

                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "결과가 없습니다.";
                } catch (e) {
                    return "네트워크 연결을 확인해주세요.";
                }
            };

            const handleCreateProject = () => {
                if (!newProjectTitle.trim()) return;
                const newId = `p_${Date.now()}`;
                const newProj = {
                    id: newId,
                    title: newProjectTitle,
                    nodes: [{ id: 'n1', content: '여기에 명령을 입력하세요.', x: 100, y: 150, type: 'input', status: 'idle' }],
                    connections: []
                };
                setProjects([...projects, newProj]);
                setCurrentProjectId(newId);
                setView('canvas');
                setIsModalOpen(false);
                setNewProjectTitle('');
            };

            const addNode = (type) => {
                const newNode = { id: `node_${Date.now()}`, content: '', x: 250, y: 250, type, status: 'idle' };
                setProjects(projects.map(p => p.id === currentProjectId ? { ...p, nodes: [...p.nodes, newNode] } : p));
            };

            const executeNode = async (nodeId) => {
                const node = currentProject.nodes.find(n => n.id === nodeId);
                if (!node || !node.content.trim()) return;

                setIsAiProcessing(true);
                // 노드 상태를 로딩으로 변경
                setProjects(prev => prev.map(p => p.id === currentProjectId ? { 
                    ...p, 
                    nodes: p.nodes.map(n => n.id === nodeId ? { ...n, status: 'loading' } : n) 
                } : p));

                const result = await callAi(node.content);
                
                const conn = currentProject.connections.find(c => c.from === nodeId);
                if (conn) {
                    // 연결된 노드가 있으면 거기에 결과 입력
                    setProjects(prev => prev.map(p => p.id === currentProjectId ? { 
                        ...p, 
                        nodes: p.nodes.map(n => 
                            n.id === conn.to ? { ...n, content: result, status: 'done' } : 
                            n.id === nodeId ? { ...n, status: 'idle' } : n
                        ) 
                    } : p));
                } else {
                    // 연결된 노드가 없으면 새로 생성
                    const outId = `out_${Date.now()}`;
                    setProjects(prev => prev.map(p => p.id === currentProjectId ? { 
                        ...p, 
                        nodes: [...p.nodes, { id: outId, content: result, x: node.x + 350, y: node.y, type: 'output', status: 'done' }],
                        connections: [...p.connections, { from: nodeId, to: outId }] 
                    } : p));
                }
                setIsAiProcessing(false);
            };

            const onMouseDown = (e, node) => {
                if (e.target.closest('button') || e.target.closest('textarea')) return;
                setDraggedNode(node.id);
                setOffset({ x: e.clientX - node.x, y: e.clientY - node.y });
            };

            const onMouseMove = (e) => {
                if (draggedNode && currentProjectId) {
                    setProjects(prev => prev.map(p => p.id === currentProjectId ? {
                        ...p,
                        nodes: p.nodes.map(n => n.id === draggedNode ? { ...n, x: e.clientX - offset.x, y: e.clientY - offset.y } : n)
                    } : p));
                }
            };

            return (
                <div className="h-screen w-full flex flex-col no-select" onMouseMove={onMouseMove} onMouseUp={() => setDraggedNode(null)}>
                    <header className="h-16 bg-white border-b flex items-center justify-between px-8 z-50 shrink-0">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setView('dashboard')}>
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="zap"/></div>
                            <span className="font-black text-xl italic text-slate-800 tracking-tighter uppercase">Flow Engine</span>
                        </div>
                        <div className="flex gap-3">
                            {view === 'canvas' && (
                                <>
                                    <button onClick={() => addNode('input')} className="px-5 py-2 bg-slate-100 rounded-xl text-xs font-bold hover:bg-slate-200 transition-colors">명령 추가</button>
                                    <button onClick={() => addNode('output')} className="px-5 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">결과 추가</button>
                                </>
                            )}
                            <button onClick={() => setIsSettingsOpen(true)} className="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all">
                                <Icon name="settings" size={20} />
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 relative overflow-hidden bg-slate-50 grid-bg">
                        {view === 'dashboard' ? (
                            <div className="p-16 max-w-6xl mx-auto">
                                <div className="flex justify-between items-end mb-12">
                                    <h1 className="text-6xl font-black text-slate-900 leading-tight">My<br/>Workflows</h1>
                                    <button onClick={() => setIsModalOpen(true)} className="px-10 py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-2xl hover:scale-105 transition-all">프로젝트 시작</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                                    {projects.map(p => (
                                        <div key={p.id} onClick={() => { setCurrentProjectId(p.id); setView('canvas'); }} className="bg-white p-10 rounded-[2.5rem] shadow-sm hover:shadow-2xl border border-slate-100 cursor-pointer group transition-all">
                                            <div className="text-indigo-600 mb-6 group-hover:scale-110 transition-transform duration-300"><Icon name="grid" size={32} /></div>
                                            <h3 className="text-2xl font-black text-slate-800 tracking-tight">{p.title}</h3>
                                            <p className="mt-2 text-slate-400 text-sm font-medium italic">Click to open engine</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="w-full h-full relative" onClick={() => setConnectionSource(null)}>
                                <svg className="absolute inset-0 w-full h-full pointer-events-none" style={{ zIndex: 5 }}>
                                    {currentProject?.connections.map((c, i) => {
                                        const f = currentProject.nodes.find(n => n.id === c.from);
                                        const t = currentProject.nodes.find(n => n.id === c.to);
                                        if (!f || !t) return null;
                                        return <path key={i} d={`M ${f.x + 300} ${f.y + 80} C ${f.x + 380} ${f.y + 80}, ${t.x - 80} ${t.y + 80}, ${t.x} ${t.y + 80}`} stroke="#6366f1" strokeWidth="4" fill="none" opacity="0.4" strokeLinecap="round" />;
                                    })}
                                </svg>
                                {currentProject?.nodes.map(node => (
                                    <div key={node.id} onMouseDown={(e) => onMouseDown(e, node)}
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            if (connectionSource && connectionSource !== node.id) {
                                                const newConns = [...currentProject.connections, { from: connectionSource, to: node.id }];
                                                setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, connections: newConns } : p));
                                                setConnectionSource(null);
                                            }
                                        }}
                                        className={`absolute w-[300px] bg-white rounded-[2rem] p-6 node-shadow border-4 transition-all z-10 
                                        ${connectionSource === node.id ? 'border-amber-400 scale-105 animate-pulse' : 'border-white'} 
                                        ${node.status === 'loading' ? 'ring-8 ring-indigo-50 border-indigo-100' : ''}`}
                                        style={{ left: node.x, top: node.y }}>
                                        <div className="flex justify-between items-center mb-4">
                                            <span className={`text-[10px] font-black uppercase px-3 py-1 rounded-full ${node.type === 'input' ? 'bg-indigo-50 text-indigo-600' : 'bg-emerald-50 text-emerald-600'}`}>{node.type}</span>
                                            <div className="flex gap-2">
                                                <button onClick={(e) => { e.stopPropagation(); setConnectionSource(node.id); }} className={`p-2 rounded-lg transition-all ${connectionSource === node.id ? 'bg-amber-400 text-white' : 'text-slate-200 hover:text-indigo-600 hover:bg-slate-50'}`}><Icon name="link" size={16}/></button>
                                                {node.type === 'input' && (
                                                    <button onClick={() => executeNode(node.id)} disabled={isAiProcessing} className="p-2 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-slate-300">
                                                        {node.status === 'loading' ? <Icon name="loader" size={16}/> : <Icon name="play" size={16}/>}
                                                    </button>
                                                )}
                                                <button onClick={() => { setProjects(prev => prev.map(p => p.id === currentProjectId ? { ...p, nodes: p.nodes.filter(n => n.id !== node.id), connections: p.connections.filter(c => c.from !== node.id && c.to !== node.id) } : p)) }} className="p-2 text-slate-200 hover:text-red-500 hover:bg-red-50 transition-all"><Icon name="trash" size={16}/></button>
                                            </div>
                                        </div>
                                        <textarea className="w-full bg-slate-50 p-4 rounded-xl border-none outline-none resize-none h-32 text-sm font-bold text-slate-700 leading-relaxed shadow-inner" 
                                            value={node.content} 
                                            placeholder={node.type === 'input' ? "무엇을 시킬까요?" : "AI 답변을 기다리는 중..."}
                                            onChange={(e) => {
                                                const val = e.target.value;
                                                setProjects(prev => prev.map(p => p.id === currentProjectId ? { 
                                                    ...p, 
                                                    nodes: p.nodes.map(n => n.id === node.id ? { ...n, content: val } : n) 
                                                } : p));
                                            }} onMouseDown={(e) => e.stopPropagation()} />
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* API Key Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[3rem] p-10 w-full max-w-md shadow-2xl">
                                <h2 className="text-2xl font-black text-slate-800 mb-4 flex items-center gap-3"><Icon name="settings" className="text-indigo-600" /> API Setup</h2>
                                <p className="text-sm text-slate-500 mb-6 font-medium leading-relaxed">Gemini API 키를 입력하세요.<br/>브라우저 로컬 저장소에 안전하게 보관됩니다.</p>
                                <input type="password" className="w-full bg-slate-50 border-2 border-slate-100 p-5 rounded-2xl mb-8 outline-none focus:border-indigo-600 font-mono text-sm transition-all" 
                                    placeholder="AIzaSy..." value={apiKey} onChange={(e) => setApiKey(e.target.value)} />
                                <div className="flex gap-4">
                                    <button onClick={() => setIsSettingsOpen(false)} className="flex-1 py-4 font-bold text-slate-400">닫기</button>
                                    <button onClick={saveApiKey} className="flex-1 py-4 font-black bg-indigo-600 text-white rounded-2xl shadow-xl hover:bg-indigo-700">저장</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Create Project Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[3rem] p-12 w-full max-w-md shadow-2xl">
                                <h2 className="text-3xl font-black text-slate-800 mb-8 italic uppercase tracking-tighter">New Engine</h2>
                                <input className="w-full bg-slate-50 border-none p-5 rounded-2xl mb-8 outline-none focus:ring-4 ring-indigo-100 font-bold text-xl transition-all" 
                                    placeholder="Project Name..." value={newProjectTitle} onChange={(e) => setNewProjectTitle(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleCreateProject()} autoFocus />
                                <div className="flex gap-4">
                                    <button onClick={() => setIsModalOpen(false)} className="flex-1 py-4 font-bold text-slate-400">취소</button>
                                    <button onClick={handleCreateProject} className="flex-1 py-4 font-black bg-indigo-600 text-white rounded-2xl shadow-xl hover:bg-indigo-700">생성</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
